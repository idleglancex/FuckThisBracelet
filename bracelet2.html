<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandora 3D: Master Control</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #87CEEB;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            user-select: none;
        }

        /* Y√úKLEME EKRANI */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 50px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            transition: opacity 0.5s;
            z-index: 10;
        }

        #msg {
            font-size: 15px;
            letter-spacing: 0.5px;
            color: #444;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #007AFF;
            animation: spin 0.8s ease-in-out infinite;
            margin: 0 auto 15px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* KONTROL PANELƒ∞ */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 240px;
            background: rgba(255, 255, 255, 0.90);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            color: #333;
            font-size: 13px;
            z-index: 5;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            max-height: 90vh;
            overflow-y: auto;
        }

        .section-title {
            font-weight: 800;
            font-size: 11px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 3px;
        }

        /* Stil Se√ßici */
        .style-group {
            display: flex;
            gap: 15px;
            margin-bottom: 5px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .radio-label input {
            accent-color: #007AFF;
            cursor: pointer;
        }

        /* Sliderlar */
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .slider-row label {
            font-weight: bold;
            width: 25px;
            color: #444;
        }

        .slider-row input {
            flex: 1;
            cursor: pointer;
            accent-color: #333;
            height: 4px;
            margin: 0 10px;
        }

        .slider-val {
            width: 35px;
            text-align: right;
            font-family: monospace;
            font-size: 11px;
            color: #666;
        }

        #footer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.4);
            pointer-events: none;
            font-weight: bold;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>

<body>

    <!-- KONTROL PANELƒ∞ -->
    <div id="controls">

        <!-- 1. G√∂r√ºn√ºm Modu -->
        <div>
            <div class="section-title">G√∂r√ºn√ºm Modu</div>
            <div class="style-group">
                <label class="radio-label">
                    <input type="radio" name="style" value="bright" checked onchange="switchStyle('bright')">
                    Bright
                </label>
                <label class="radio-label">
                    <input type="radio" name="style" value="metal" onchange="switchStyle('metal')">
                    Metal
                </label>
            </div>
        </div>

        <!-- 2. Rotasyon Ayarƒ± -->
        <div>
            <div class="section-title">D√∂nd√ºr (Rotation)</div>
            <div class="slider-group">
                <div class="slider-row">
                    <label>X</label>
                    <input type="range" min="-180" max="180" value="-90" oninput="updateCharmRotation('x', this.value)">
                    <span id="rot-val-x" class="slider-val">-90¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Y</label>
                    <input type="range" min="-180" max="180" value="90" oninput="updateCharmRotation('y', this.value)">
                    <span id="rot-val-y" class="slider-val">90¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Z</label>
                    <input type="range" min="-180" max="180" value="0" oninput="updateCharmRotation('z', this.value)">
                    <span id="rot-val-z" class="slider-val">0¬∞</span>
                </div>
            </div>
        </div>

        <!-- 3. Konum Ayarƒ± -->
        <div>
            <div class="section-title">Kaydƒ±r (Position)</div>
            <div class="slider-group">
                <div class="slider-row">
                    <label>X</label>
                    <input type="range" min="-2" max="2" step="0.05" value="0"
                        oninput="updateCharmPosition('x', this.value)">
                    <span id="pos-val-x" class="slider-val">0</span>
                </div>
                <div class="slider-row">
                    <label>Y</label>
                    <input type="range" min="-2" max="2" step="0.05" value="-0.3"
                        oninput="updateCharmPosition('y', this.value)">
                    <span id="pos-val-y" class="slider-val">-0.3</span>
                </div>
                <div class="slider-row">
                    <label>Z</label>
                    <input type="range" min="-2" max="2" step="0.05" value="0"
                        oninput="updateCharmPosition('z', this.value)">
                    <span id="pos-val-z" class="slider-val">0</span>
                </div>
            </div>
        </div>

        <!-- 4. Se√ßili Charm Kontrol√º -->
        <div id="charm-controls"
            style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 5px; opacity: 0.5; pointer-events: none;">
            <div class="section-title" style="color:#E91E63">Se√ßili Charm Ayarlarƒ±</div>

            <div style="font-size:10px; color:#888; margin-bottom:5px; font-style:italic;" id="selected-charm-name">
                (Bir charm se√ßin)
            </div>

            <!-- Charm Rotasyon -->
            <div class="section-title">Charm D√∂nd√ºr</div>
            <div class="slider-group">
                <div class="slider-row">
                    <label>Y</label>
                    <input type="range" min="-180" max="180" value="0"
                        oninput="updateSelectedCharmRotation('y', this.value)">
                    <span id="c-rot-val-y" class="slider-val">0¬∞</span>
                </div>
                <div class="slider-row">
                    <label>Z</label>
                    <input type="range" min="-180" max="180" value="0"
                        oninput="updateSelectedCharmRotation('z', this.value)">
                    <span id="c-rot-val-z" class="slider-val">0¬∞</span>
                </div>
            </div>

            <!-- Charm Konum -->
            <div class="section-title" style="margin-top:5px;">Charm Kaydƒ±r</div>
            <div class="slider-group">
                <div class="slider-row">
                    <label>X</label>
                    <input type="range" min="-2" max="2" step="0.05" value="0"
                        oninput="updateSelectedCharmPosition('x', this.value)">
                    <span id="c-pos-val-x" class="slider-val">0</span>
                </div>
            </div>

            <button onclick="deleteSelectedCharm()"
                style="width:100%; background:#ff4444; color:white; border:none; padding:8px; border-radius:4px; margin-top:10px; cursor:pointer; font-size:11px; font-weight:bold;">
                üóëÔ∏è Sƒ∞L / DELETE
            </button>
        </div>

    </div>

    <div id="loading">
        <div class="spinner"></div>
        <div id="msg">AT√ñLYE HAZIRLANIYOR...</div>
    </div>

    <div id="footer">PANDORA 3D VIEWER</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        const pmremGenerator = new THREE.PMREMGenerator(renderer);
        scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;
        controls.maxPolarAngle = Math.PI / 2 - 0.05;

        // --- SELECTION SETUP ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let selectionBox = new THREE.BoxHelper(new THREE.Mesh(), 0xffff00);
        selectionBox.visible = false;
        scene.add(selectionBox);

        // --- I≈ûIKLAR ---
        const lights = { bright: [], metal: [] };

        // Bright Lights
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 2.0);
        hemiLight.position.set(0, 20, 0);
        lights.bright.push(hemiLight);
        scene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 3.0);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        lights.bright.push(dirLight);
        scene.add(dirLight);

        const fillLight = new THREE.DirectionalLight(0xffeedd, 1.5);
        fillLight.position.set(-5, 5, -5);
        lights.bright.push(fillLight);
        scene.add(fillLight);

        // Metal Lights
        const spotLight = new THREE.SpotLight(0xffffff, 20);
        spotLight.position.set(5, 15, 5);
        spotLight.castShadow = true;
        spotLight.visible = false;
        lights.metal.push(spotLight);
        scene.add(spotLight);

        const rimLight = new THREE.DirectionalLight(0xccddff, 2);
        rimLight.position.set(-5, 2, -10);
        rimLight.visible = false;
        lights.metal.push(rimLight);
        scene.add(rimLight);

        const ambientMetal = new THREE.AmbientLight(0xffffff, 0.2);
        ambientMetal.visible = false;
        lights.metal.push(ambientMetal);
        scene.add(ambientMetal);

        // --- GRUPLAR ---
        const mainGroup = new THREE.Group();
        scene.add(mainGroup);
        const braceletGroup = new THREE.Group();
        mainGroup.add(braceletGroup);
        const charmsGroup = new THREE.Group();
        braceletGroup.add(charmsGroup);

        const plane = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.ShadowMaterial({ opacity: 0.2, color: 0x000000 }));
        plane.rotation.x = -Math.PI / 2;
        plane.position.y = -2.5;
        plane.receiveShadow = true;
        mainGroup.add(plane);

        const loaders = { obj: new OBJLoader(), gltf: new GLTFLoader(), fbx: new FBXLoader() };
        const uiMsg = document.getElementById('msg');
        const uiLoading = document.getElementById('loading');

        // --- FONKSƒ∞YONLAR ---

        // GLOBAL ROTATION (Bilezik T√ºm√º)
        window.updateCharmRotation = function (axis, value) {
            const rad = THREE.MathUtils.degToRad(value);
            if (axis === 'x') mainGroup.rotation.x = rad;
            if (axis === 'y') mainGroup.rotation.y = rad;
            if (axis === 'z') mainGroup.rotation.z = rad;
            document.getElementById(`rot-val-${axis}`).innerText = value + "¬∞";
        };

        // GLOBAL POSITION (Bilezik T√ºm√º)
        window.updateCharmPosition = function (axis, value) {
            if (axis === 'x') mainGroup.position.x = parseFloat(value);
            if (axis === 'y') mainGroup.position.y = parseFloat(value);
            if (axis === 'z') mainGroup.position.z = parseFloat(value);
            document.getElementById(`pos-val-${axis}`).innerText = value;
        };

        // INDIVIDUAL SELECTION & CONTROL
        window.selectCharm = function (object) {
            // Find the top-level group for this charm inside 'charmsGroup'
            // The structure is charmsGroup -> pivot -> mesh
            // So we need to find the specific mesh object that we stored in allCharmMeshes

            // However, our click might hit a child of the mesh.
            let targetMesh = null;
            object.traverseAncestors((ancestor) => {
                if (allCharmMeshes.includes(ancestor)) targetMesh = ancestor;
            });
            if (allCharmMeshes.includes(object)) targetMesh = object;

            if (targetMesh) {
                selectedCharm = targetMesh;

                // Show Highlight
                selectionBox.setFromObject(selectedCharm);
                selectionBox.visible = true;

                // Enable UI
                const ui = document.getElementById('charm-controls');
                ui.style.opacity = '1';
                ui.style.pointerEvents = 'auto';

                // Update UI values
                document.getElementById('selected-charm-name').innerText = selectedCharm.userData.filename || "Charm";

                document.getElementById('c-rot-val-y').innerText = Math.round(THREE.MathUtils.radToDeg(selectedCharm.rotation.y)) + "¬∞";
                document.getElementById('c-rot-val-z').innerText = Math.round(THREE.MathUtils.radToDeg(selectedCharm.rotation.z)) + "¬∞";

                // For X position (sliding along the bracelet essentially, but relative to pivot)
                // Actually, moving 'x' inside the pivot moves it IN/OUT radially if pivot is rotated.
                // Or if we move it along Z relative to Pivot? 
                // Let's assume the user wants to tweak local position.
                document.getElementById('c-pos-val-x').innerText = selectedCharm.position.x.toFixed(2);

                // Stop global auto-rotate to focus
                controls.autoRotate = false;
            } else {
                deselectCharm();
            }
        };

        function deselectCharm() {
            selectedCharm = null;
            selectionBox.visible = false;
            const ui = document.getElementById('charm-controls');
            ui.style.opacity = '0.5';
            ui.style.pointerEvents = 'none';
            document.getElementById('selected-charm-name').innerText = "(Bir charm se√ßin)";
            controls.autoRotate = true;
        }
        window.deleteSelectedCharm = async function () {
            if (!selectedCharm) return;
            if (!confirm("Are you sure you want to delete this charm?")) return;

            const filename = selectedCharm.userData.filename;
            const isLocal = selectedCharm.userData.isLocal;
            const localId = selectedCharm.userData.localId;

            try {
                if (isLocal && localId) {
                    await deleteCharmFromDB(localId);
                } else {
                    await fetch(`/api/delete?filename=${filename}`, { method: 'DELETE' });
                }

                const pivot = selectedCharm.parent;
                pivot.remove(selectedCharm);
                charmsGroup.remove(pivot);

                const idx = allCharmMeshes.indexOf(selectedCharm);
                if (idx > -1) allCharmMeshes.splice(idx, 1);

                deselectCharm();
            } catch (e) {
                console.error(e);
                alert("Charm removed from scene, but storage delete might have failed.");

                const pivot = selectedCharm.parent;
                if (pivot) {
                    pivot.remove(selectedCharm);
                    charmsGroup.remove(pivot);
                }
                const idx = allCharmMeshes.indexOf(selectedCharm);
                if (idx > -1) allCharmMeshes.splice(idx, 1);
                deselectCharm();
            }
        };

        window.addEventListener('mousedown', (event) => {
            if (event.target.closest('#controls') || event.target.closest('#charm-controls')) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(charmsGroup.children, true);

            if (intersects.length > 0) {
                window.selectCharm(intersects[0].object);
            }
        });

        function loadModelSmart(url) {
            return new Promise((resolve) => {
                const ext = url.split('.').pop().toLowerCase();
                const loader = (ext === 'fbx') ? loaders.fbx : (ext === 'obj' ? loaders.obj : loaders.gltf);
                loader.load(url, (data) => {
                    let model = data.scene || data;
                    const box = new THREE.Box3().setFromObject(model);
                    const size = box.getSize(new THREE.Vector3());
                    if (Math.max(size.x, size.y, size.z) > 0) {
                        const scale = CHARM_SCALE / Math.max(size.x, size.y, size.z);
                        model.scale.set(scale, scale, scale);
                        model.position.sub(new THREE.Box3().setFromObject(model).getCenter(new THREE.Vector3()).multiplyScalar(scale));
                        model.position.y -= new THREE.Box3().setFromObject(model).max.y;
                    }
                    model.traverse(c => { if (c.isMesh) { c.castShadow = true; c.receiveShadow = true; if (!c.material) c.material = new THREE.MeshStandardMaterial({ color: 0xffffff }); } });
                    resolve(model);
                }, undefined, () => resolve(null));
            });
        }
        scene.fog.color.set(style === 'bright' ? SKY_COLOR : 0x111111);

        // Toggle Lights
        lights.bright.forEach(l => l.visible = (style === 'bright'));
        lights.metal.forEach(l => l.visible = (style === 'metal'));

        // Toggle Floor
        plane.material.color.set(style === 'bright' ? 0x000000 : 0x333333);
        plane.material.opacity = style === 'bright' ? 0.2 : 0.5;
        };

        // --- INIT SEQUENCE ---
        async function init() {
            console.log("INIT STARTED");
            try {
                uiMsg.innerText = "Bƒ∞LEKLƒ∞K ƒ∞≈ûLENƒ∞YOR...";
                await loadMainBracelet();

                uiMsg.innerText = "CHARMLAR HAZIRLANIYOR...";

                // Load Static Files (API)
                const staticFiles = await scanSourceFolder();

                // Load Local DB Files (IndexedDB)
                const localCharms = await getCharmsFromDB();

                const allItems = [
                    ...staticFiles.map(url => ({ type: 'url', val: url })),
                    ...localCharms.map(item => ({ type: 'db', val: item }))
                ];

                if (allItems.length > 0) await loadAndArrangeCharms(allItems);

                window.switchStyle('bright');
                uiMsg.innerText = "HAZIR!";
                console.log("INIT DONE");
                setTimeout(() => { uiLoading.style.opacity = 0; setTimeout(() => uiLoading.remove(), 500); }, 800);
            } catch (error) {
                console.error("INIT ERROR:", error);
                uiMsg.innerText = "HATA: " + error.message;
            }
        }

        // Start
        init();
    </script>
</body>

</html>